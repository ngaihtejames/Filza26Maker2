name: 📦 Build Filza26Maker (Auto .ipa Repack)

on:
  workflow_dispatch:  # lets you run it manually
    inputs:
      filza_url:
        description: "Optional: custom Filza .deb URL (leave empty for TiGi default)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 🧰 Checkout repository
        uses: actions/checkout@v4

      - name: 🧱 Prepare fake Desktop directory (for macOS scripts)
        run: |
          mkdir -p ~/Desktop
          echo "Created fake Desktop folder to catch script output."

      - name: ⚙️ Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget curl zip unzip tar binutils coreutils
          echo "✅ Dependencies installed."

      - name: 🌐 Download Filza tweak from TiGi Software
        run: |
          echo "Fetching Filza tweak package..."
          if [ -n "${{ github.event.inputs.filza_url }}" ]; then
            echo "Using custom URL: ${{ github.event.inputs.filza_url }}"
            wget -O Filza.deb "${{ github.event.inputs.filza_url }}" || true
          fi

          if [ ! -f "Filza.deb" ]; then
            echo "No custom URL or failed download — using default TiGi source."
            wget -O Filza.deb https://tigisoftware.com/repo/Filza.deb || \
            wget -O Filza.deb https://tigisoftware.com/repo/com.tigisoftware.filza_3.9.6_iphoneos-arm.deb
          fi

          ls -lh Filza.deb
          echo "✅ Filza tweak downloaded successfully."

      - name: 🚀 Run Filza26Maker
        run: |
          echo "Starting Filza26Maker build..."
          chmod +x ./Filza26Maker.sh
          ./Filza26Maker.sh Filza.deb || ./Filza26Maker.sh
          echo "Build script finished."

      - name: 📂 Detect and zip output
        run: |
          mkdir -p final_output
          echo "Searching for Filza build results..."
          find ~/Desktop -type f -name "*.ipa" -exec cp {} final_output/ \; || true
          find . -type f -name "*.ipa" -exec cp {} final_output/ \; || true

          if [ "$(ls -A final_output)" ]; then
            cd final_output
            zip -r Filza26_Output.zip ./*
            echo "✅ Output packaged successfully."
          else
            echo "⚠️ No IPA output found."
          fi

      - name: 📤 Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Filza26_Build
          path: final_output/Filza26_Output.zip